CREATE OR ALTER PROCEDURE [silver].[load_silver] AS 
BEGIN
DECLARE @start_time DATETIME2, @end_time DATETIME2, @batch_start_time DATETIME2, @batch_end_time DATETIME2
BEGIN TRY
SET @batch_start_time = CURRENT_TIMESTAMP;

PRINT '==================================================================';
PRINT 'Loading the Silver Layer';
PRINT '==================================================================';

PRINT '------------------------------------------------------------------';
PRINT 'Creating and ingesting data into silver glb tables';
PRINT '------------------------------------------------------------------';

SET @start_time = CURRENT_TIMESTAMP;
PRINT '>> creating table: silver.cust_info_glb';
IF OBJECT_ID ('silver.cust_info_glb', 'U') IS NOT NULL
DROP TABLE silver.cust_info_glb;
CREATE TABLE silver.cust_info_glb
(
  customer_id VARCHAR(50),
  customer_key VARCHAR(50),
  customer_firstname VARCHAR(50),
  customer_lastname VARCHAR(50),
  customer_marital_status VARCHAR(50),
  customer_gender VARCHAR(50),
  customer_create_date DATE,
  processed_date DATE
);

PRINT '>> Truncating Table:silver.cust_info_glb';
TRUNCATE TABLE silver.cust_info_glb;
PRINT '>> ingesting data into: silver.cust_info_glb';
INSERT INTO silver.cust_info_glb
SELECT
cst_id AS customer_id,
cst_key AS customer_key,
TRIM(cst_firstname) AS customer_firstname,
TRIM(cst_lastname) AS customer_lastname,
CASE
    WHEN UPPER(cst_marital_status) = 'S' THEN 'Single'
    WHEN UPPER(cst_marital_status) = 'M' THEN 'Married'
    WHEN UPPER(cst_marital_status) IS NULL OR UPPER(cst_marital_status) = '' THEN 'n/a'
    ELSE cst_marital_status
    END AS customer_marital_status,
CASE
    WHEN UPPER(cst_gender) = 'F' THEN 'Female'
    WHEN UPPER(cst_gender) = 'M' THEN 'Male'
    WHEN UPPER(cst_gender) IS NULL OR UPPER(cst_gender) = '' THEN 'n/a'
    ELSE cst_gender
    END AS customer_gender,
cst_create_date AS customer_create_date,
GETDATE() as processed_date
FROM (
        SELECT *,
        ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) AS occurrence
        FROM [bronze].[cust_info_glb]
        ) rd
        WHERE rd.occurrence = 1
          AND cst_id IS NOT NULL;
SET @end_time = CURRENT_TIMESTAMP;
PRINT '>> load duration: ' + cast(datediff(second, @start_time, @end_time) as varchar) + ' seconds';
PRINT '----------';


SET @start_time = CURRENT_TIMESTAMP;
PRINT '>> creating table: silver.sales_details_glb';
IF OBJECT_ID ('silver.sales_details_glb', 'U') IS NOT NULL
DROP TABLE silver.sales_details_glb;
CREATE TABLE silver.sales_details_glb
(
  sales_order_number varchar(50),
  sales_product_key varchar(50),
  sales_customer_id varchar(50),
  sales_order_date_id varchar(50),
  sales_order_date date,
  sales_ship_date_id varchar(50),
  sales_ship_date date,
  sales_due_date_id varchar(50),
  sales_due_date date,
  sales_amount int,
  sales_quantity int,
  sales_price int,
  source_date_dq_check varchar(12),
  source_ship_dq_check varchar(12),
  source_due_dq_check varchar(12),
  processed_date date
  );

PRINT '>> Truncating Table:silver.sales_details_glb';
TRUNCATE TABLE silver.sales_details_glb;
PRINT '>> Ingesting Data into: silver.sales_details_glb';
INSERT INTO silver.sales_details_glb
SELECT 
sls_ord_num as sales_order_number,
sls_prd_key as sales_product_key,
sls_cust_id as sales_customer_id,
sls_order_dt as sales_order_date_id,
CASE
    WHEN CAST(sls_order_dt as int) <= 0 OR LEN(sls_order_dt) <> 8 THEN NULL
    ELSE CAST(CAST(sls_order_dt as varchar) as date)
    END AS sales_order_date,
sls_ship_dt as sales_ship_date_id,
CASE
    WHEN CAST(sls_ship_dt as int) <= 0 OR LEN(sls_ship_dt) <> 8 THEN NULL
    ELSE CAST(CAST(sls_ship_dt as varchar) as date)
    END AS sales_ship_date,
sls_due_dt as sales_due_date_id,
CASE
    WHEN CAST(sls_due_dt as int) <= 0 OR LEN(sls_due_dt) <> 8 THEN NULL
    ELSE CAST(CAST(sls_due_dt as varchar) as date)
    END AS sales_due_date,
CASE
    WHEN sls_sales <=0 OR sls_sales < sls_price  OR sls_sales is NULL THEN sls_price
    ELSE sls_sales END AS sales_amount,
COALESCE(sls_quantity, 0) as sales_quantity,
CASE
    WHEN sls_price <= 0 OR sls_price < sls_sales  OR sls_price is NULL THEN sls_sales
    ELSE sls_price END AS sales_price,
CASE 
    WHEN CAST(sls_order_dt as int) <= 0 OR LEN(sls_order_dt) <> 8 THEN 'Invalid'
    ELSE 'Valid'
    END AS source_date_dq_check,
CASE 
    WHEN CAST(sls_ship_dt as int) <= 0 OR LEN(sls_ship_dt) <> 8 THEN 'Invalid'
    ELSE 'Valid'
    END AS source_ship_dq_check,
CASE 
    WHEN CAST(sls_due_dt as int) <= 0 OR LEN(sls_due_dt) <> 8 THEN 'Invalid'
    ELSE 'Valid'
    END AS source_due_dq_check,
GETDATE() as processed_date
FROM [bronze].[sales_details_glb];
SET @end_time = CURRENT_TIMESTAMP;
PRINT '>> load duration: ' + cast(datediff(second, @start_time, @end_time) as varchar) + ' seconds';
PRINT '----------';


SET @start_time = CURRENT_TIMESTAMP;
PRINT '>> creating table: silver.prd_info_glb';
IF OBJECT_ID ('silver.prd_info_glb', 'U') IS NOT NULL
  DROP TABLE silver.prd_info_glb;
  CREATE TABLE silver.prd_info_glb
  (
  product_id varchar(50),
  source_product_key varchar(50),
  product_key varchar(50),
  product_name varchar(100),
  product_cost INT,
  product_line varchar(50),
  product_start_date date,
  product_end_date date,
  product_date_data_quality_check varchar(25),
  processed_date date);

PRINT '>> Truncating Table:silver.prd_info_glb';
TRUNCATE TABLE silver.prd_info_glb;
PRINT '>> Ingesting Data into: silver.prd_info_glb';
INSERT INTO silver.prd_info_glb
SELECT 
prd_id as product_id,
SUBSTRING(prd_key, CHARINDEX('-', prd_key, CHARINDEX('-', prd_key) + 1) + 1, LEN(prd_key)) as source_product_key,
REPLACE(LEFT(prd_key, CHARINDEX('-', prd_key, CHARINDEX('-', prd_key) + 1) -1), '-', '_') as product_key,
prd_nm as product_name,
COALESCE(prd_cost, 0) as product_cost,
CASE 
    WHEN TRIM(prd_line) = 'M' THEN 'Mountain'
    WHEN TRIM(prd_line) = 'S' THEN 'Sport'
    WHEN TRIM(prd_line) = 'R' THEN 'Road'
    WHEN TRIM(prd_line) = 'T' THEN 'Touring'
    ELSE 'n/a'
    END AS product_line,
product_start_date,
product_end_date,
CASE 
    WHEN product_start_date > product_end_date THEN 'Invalid'
    ELSE 'Valid'
    END AS product_date_data_quality_check,
GETDATE() as processed_date
FROM (
SELECT *,
CASE
    WHEN prd_start_dt > prd_end_dt THEN prd_end_dt
    ELSE prd_start_dt
    END AS product_start_date,
CASE
    WHEN prd_end_dt < prd_start_dt THEN prd_start_dt
    ELSE prd_end_dt
    END AS product_end_date,
ROW_NUMBER() OVER (PARTiTION BY prd_key ORDER BY prd_start_dt  DESC) AS occurence
FROM [bronze].[prd_info_glb]
) rd
WHERE rd.occurence = 1;
SET @end_time = CURRENT_TIMESTAMP;
PRINT '>> load duration: ' + cast(datediff(second, @start_time, @end_time) as varchar) + ' seconds';
PRINT '----------';


SET @start_time = CURRENT_TIMESTAMP;
PRINT '>> Renaming tables: cust_az12_glb: cust_additional_attributes_glb'
PRINT '>> creating table: silver.cust_additional_attributes_glb';
IF OBJECT_ID ('silver.cust_additional_attributes_glb', 'U') IS NOT NULL
DROP TABLE silver.cust_additional_attributes_glb;
CREATE TABLE silver.cust_additional_attributes_glb
(
  CID varchar(50),
  customer_key varchar(50),
  date_of_birth date,
  customer_gender varchar(50),
  processed_date date
);

PRINT '>> Truncating Table:silver.cust_additional_attributes_glb';
TRUNCATE TABLE silver.cust_additional_attributes_glb;
PRINT '>> Ingesting Data into: silver.cust_additional_attributes_glb';
INSERT INTO silver.cust_additional_attributes_glb
SELECT
CID,
CASE
    WHEN CID LIKE '%NAS%' THEN REPLACE(CID, 'NAS', '')
    ELSE CID
    END AS customer_key,
BDATE as date_of_birth,
CASE
    WHEN GEN = 'F' THEN 'Female'
    WHEN GEN = 'M' THEN 'Male'
    WHEN GEN IS NULL OR GEN = '' THEN 'n/a'
    ELSE GEN
    END AS customer_gender,
GETDATE() as processed_date
FROM [bronze].[cust_az12_glb];
SET @end_time = CURRENT_TIMESTAMP;
PRINT '>> load duration: ' + cast(datediff(second, @start_time, @end_time) as varchar) + ' seconds';
PRINT '----------';


SET @start_time = CURRENT_TIMESTAMP;
PRINT '>> Renaming tables: loc_a101_glb: cust_loc_attributes_glb'
PRINT '>> creating table: silver.cust_loc_attributes_glb';
IF OBJECT_ID ('silver.cust_loc_attributes_glb', 'U') IS NOT NULL
DROP TABLE silver.cust_loc_attributes_glb;
CREATE TABLE silver.cust_loc_attributes_glb
(
   customer_location_id varchar(50),
   customer_key varchar(50),
   customer_country varchar(50),
   processed_date date
);

PRINT '>> Truncating Table:silver.cust_loc_attributes_glb';
TRUNCATE TABLE silver.cust_loc_attributes_glb;
PRINT '>> Ingesting Data into: silver.cust_loc_attributes_glb';
INSERT INTO silver.cust_loc_attributes_glb
SELECT 
CID as customer_location_id,
CASE
    WHEN CID LIKE '%-%' THEN REPLACE(CID, '-', '')
    ELSE CID
    END AS customer_key,
CASE 
    WHEN cntry IN ('USA', 'US', 'us', 'usa') THEN 'United States'
    WHEN cntry IN ('DE', 'de') THEN 'Germany'
    WHEN cntry IS NULL OR cntry = '' THEN 'n/a'
    ELSE cntry
    END AS customer_country,
GETDATE() as processed_date
FROM [bronze].[loc_a101_glb];
SET @end_time = CURRENT_TIMESTAMP;
PRINT '>> load duration: ' + cast(datediff(second, @start_time, @end_time) as varchar) + ' seconds';
PRINT '----------';


SET @start_time = CURRENT_TIMESTAMP;
PRINT '>> Renaming tables: px_cat_g1v2_glb: prd_additional_attributes_glb'
PRINT '>> creating table: silver.prd_additional_attributes_glb';
IF OBJECT_ID ('silver.prd_additional_attributes_glb', 'U') IS NOT NULL
DROP TABLE silver.prd_additional_attributes_glb;
CREATE TABLE silver.prd_additional_attributes_glb
(
  product_category_key varchar(50),
  product_category varchar(50),
  product_subcategory varchar(50),
  maintenance varchar(50),
  processed_date date
);

PRINT '>> Truncating Table:silver.prd_additional_attributes_glb';
TRUNCATE TABLE silver.prd_additional_attributes_glb;
PRINT '>> Ingesting Data into: silver.prd_additional_attributes_glb';
INSERT INTO silver.prd_additional_attributes_glb
SELECT
id as product_category_key,
cat as product_category,
subcat as product_subcategory,
maintenance,
GETDATE() as processed_date
FROM [bronze].[px_cat_g1v2_glb];
SET @end_time = CURRENT_TIMESTAMP;
PRINT '>> load duration: ' + cast(datediff(second, @start_time, @end_time) as varchar) + ' seconds';
PRINT '----------';


PRINT '------------------------------------------------------------------';
PRINT 'Creating and ingesting data into olist tables';
PRINT '------------------------------------------------------------------';

SET @start_time = CURRENT_TIMESTAMP;
PRINT '>> creating table: silver.customers_olist';
IF OBJECT_ID ('silver.customers_olist', 'U') IS NOT NULL
DROP TABLE silver.customers_olist;
CREATE TABLE silver.customers_olist
(
   customer_id varchar(255),
   customer_unique_id varchar(255),
   customer_zip_code varchar(50),
   customer_city varchar(50),
   customer_state varchar(50),
   customer_country varchar(100),
   processed_date date
);



PRINT '>> Truncating Table:silver.customers_olist';
TRUNCATE TABLE silver.customers_olist;
PRINT '>> Ingesting Data into: silver.customers_olist';
INSERT INTO silver.customers_olist
SELECT 
*,
'Brazil' as customer_country,
GETDATE() as processed_date
FROM [bronze].[customers_olist];
SET @end_time = CURRENT_TIMESTAMP;
PRINT '>> load duration: ' + cast(datediff(second, @start_time, @end_time) as varchar) + ' seconds';
PRINT '----------';


SET @start_time = CURRENT_TIMESTAMP;
PRINT '>> creating table: silver.order_items_olist';
IF OBJECT_ID ('silver.order_items_olist', 'U') IS NOT NULL
DROP TABLE silver.order_items_olist;
CREATE TABLE silver.order_items_olist
(
   order_id varchar(255),
   order_quantity int,
   product_id varchar(255),
   seller_id varchar(255),
   shipping_limit_date date,
   price decimal(10,2),
   freight_value decimal(10,2),
   processed_date date
);

PRINT '>> Truncating Table:silver.order_items_olist';
TRUNCATE TABLE silver.order_items_olist;
PRINT '>> Ingesting Data into: silver.order_items_olist';
INSERT INTO silver.order_items_olist
SELECT 
*,
GETDATE() as processed_date
FROM [bronze].[order_items_olist];
SET @end_time = CURRENT_TIMESTAMP;
PRINT '>> load duration: ' + cast(datediff(second, @start_time, @end_time) as varchar) + ' seconds';
PRINT '----------';


SET @start_time = CURRENT_TIMESTAMP;
PRINT '>> creating table: silver.order_payments_olist';
IF OBJECT_ID ('silver.order_payments_olist', 'U') IS NOT NULL
DROP TABLE silver.order_payments_olist;
CREATE TABLE silver.order_payments_olist
(
   order_id varchar(255),
   payment_sequential int,
   payment_type varchar(50),
   payment_installments int,
   payment_value decimal(10, 2),
   processed_date date
);

PRINT '>> Truncating Table:silver.order_payments_olist';
TRUNCATE TABLE silver.order_payments_olist;
PRINT '>> Ingesting Data into: silver.order_payments_olist';
INSERT INTO silver.order_payments_olist
SELECT 
*,
GETDATE() as processed_date
FROM [bronze].[order_payments_olist];
SET @end_time = CURRENT_TIMESTAMP;
PRINT '>> load duration: ' + cast(datediff(second, @start_time, @end_time) as varchar) + ' seconds';
PRINT '----------';

SET @start_time = CURRENT_TIMESTAMP;
PRINT '>> creating table: silver.orders_olist';
IF OBJECT_ID ('silver.orders_olist', 'U') IS NOT NULL
DROP TABLE silver.orders_olist;
CREATE TABLE silver.orders_olist
(
   order_id varchar(255),
   customer_id varchar(255),
   order_status varchar(50),
   order_purchase_timestamp date,
   order_approved_at date,
   order_delivered_carrier_date date,
   order_delivered_customer_date date,
   order_estimated_delivery_date date,
   processed_date date
);

PRINT '>> Truncating Table:silver.orders_olist';
TRUNCATE TABLE silver.orders_olist;
PRINT '>> Ingesting Data into: silver.orders_olist';
INSERT INTO silver.orders_olist
SELECT 
*,
GETDATE() as processed_date
FROM [bronze].[orders_olist];
SET @end_time = CURRENT_TIMESTAMP;
PRINT '>> load duration: ' + cast(datediff(second, @start_time, @end_time) as varchar) + ' seconds';
PRINT '----------';

SET @start_time = CURRENT_TIMESTAMP;
PRINT '>> creating table: silver.product_category_olist';
IF OBJECT_ID ('silver.product_category_olist', 'U') IS NOT NULL
DROP TABLE silver.product_category_olist;
CREATE TABLE silver.product_category_olist
(
   product_category_name varchar(255),
   product_category_name_english varchar(255),
   processed_date date
);

PRINT '>> Truncating Table:silver.product_category_olist';
TRUNCATE TABLE silver.product_category_olist;
PRINT '>> Ingesting Data into: silver.product_category_olist';
INSERT INTO silver.product_category_olist
SELECT 
*,
GETDATE() as processed_date
FROM [bronze].[product_category_olist];
SET @end_time = CURRENT_TIMESTAMP;
PRINT '>> load duration: ' + cast(datediff(second, @start_time, @end_time) as varchar) + ' seconds';
PRINT '----------';

SET @start_time = CURRENT_TIMESTAMP;
PRINT '>> creating table: silver.products_olist';
IF OBJECT_ID ('silver.products_olist', 'U') IS NOT NULL
DROP TABLE silver.products_olist;
CREATE TABLE silver.products_olist
(
   product_id varchar(255),
   product_category_name varchar(255),
   product_name_length int,
   product_description_length decimal(10,2),
   product_photos_qty int,
   product_weight_g decimal(10,2),
   product_length_cm decimal(10,2),
   product_height_cm decimal(10,2),
   product_width_cm decimal(10,2),
   processed_date date
);

PRINT '>> Truncating Table:silver.products_olist';
TRUNCATE TABLE silver.products_olist;
PRINT '>> Ingesting Data into: silver.products_olist';
INSERT INTO silver.products_olist
SELECT 
*,
GETDATE() as processed_date
FROM [bronze].[products_olist];
SET @end_time = CURRENT_TIMESTAMP;
PRINT '>> load duration: ' + cast(datediff(second, @start_time, @end_time) as varchar) + ' seconds';
PRINT '----------';

SET @start_time = CURRENT_TIMESTAMP;
PRINT '>> creating table: silver.geo_location_olist'; 
IF OBJECT_ID ('silver.geo_location_olist', 'U') IS NOT NULL
DROP TABLE silver.geo_location_olist;
CREATE TABLE silver.geo_location_olist
(
   geolocation_zip_code varchar(50),
   geolocation_lat varchar(50),
   geolocation_lng varchar(50),
   geolocation_city varchar(50),
   geolocation_state varchar(50),
   processed_date date
);

PRINT '>> Truncating Table:silver.geo_location_olist';
TRUNCATE TABLE silver.geo_location_olist;
PRINT '>> Ingesting Data into: silver.geo_location_olist';
INSERT INTO silver.geo_location_olist
SELECT 
*,
GETDATE() as processed_date
FROM [bronze].[geo_location_olist];
SET @end_time = CURRENT_TIMESTAMP;
PRINT '>> load duration: ' + cast(datediff(second, @start_time, @end_time) as varchar) + ' seconds';
PRINT '----------';


SET @batch_end_time = CURRENT_TIMESTAMP;
PRINT '==================================================================================================================';
PRINT 'loading silver layer completed';
PRINT '  - total load duration:  ' + cast(datediff(second, @batch_start_time, @batch_end_time) as varchar) + ' seconds';
PRINT '===================================================================================================================';

END TRY
BEGIN CATCH
PRINT '==========================================================================';
PRINT 'error occured during loading bronze layer'
PRINT 'error message' + error_message();
PRINT 'error message' + CAST(error_number() as varchar);
PRINT 'error message' + CAST(error_state() as varchar);
PRINT '==========================================================================';
END CATCH
END

